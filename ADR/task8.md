# ADR Выявление и устранение «горячих» шардов

## Набор метрик
**Горячий шард** - шард, метрика которого отличается на заданную (относительную) величину от средней по шардам.
В Prometeus необходимо создать алерты на настраиваемую величину.

### Метрики на уровне шарда (Node-Level Metrics)
Для каждого шарда необходимо настроить сбор метрик (источник: Prometheus + MongoDB Exporter):
| Метрика | Суть | Назначение |
|--------|------|----------|
|mongodb_shard_disk_usage_bytes|Дисковая утилизация|Объем занятого пространства на диске. Позволяет отслеживать дисбаланс по объему данных.|
|mongodb_shard_iops_read, mongodb_shard_iops_write|Операции ввода-вывода (IOPS)|Количество операций чтения и записи в секунду. Ключевой показатель нагрузки на диск.|
|mongodb_shard_cpu_usage_percent|Загрузка CPU|Процент использования процессора. Резкий рост может указывать на "горячий" шард.|
|mongodb_shard_memory_resident_bytes|Оперативная память|Статистика по использованию RAM, особенно resident memory, чтобы избежать вытеснения индексов на диск.|
|mongodb_shard_connections_current|Количество подключений|Резкое увеличение числа подключений к конкретному шарду — тревожный сигнал.|
|mongodb_shard_disk_available_bytes|Свободное место на диске|Следить, чтобы заранее избегать «out‑of‑space»|
|mongodb_shard_memory_virtual_bytes|Объем виртуальной памяти, зарезервированной шардом|Если virtual сильно растет, а resident стоит на месте, это может указывать на создание слишком большого количества незакрытых соединений или утечку в структурах управления памятью.|

### Метрики на уровне коллекции и чанков (Collection/Chunk-Level Metrics)
Для каждой коллекции/шарда необходимо настроить сбор метрик:
| Метрика | Суть | Назначение | Источник|
|--------|------|----------|----------|
|mongodb_collection_shard_operations_total|Статистика обращений по шардам|Мониторинг должен считать количество запросов (read/write), приходящихся на каждый шард для конкретной коллекции.|Кастомный скрипт/агрегация.|
|mongodb_shard_chunks_count|Распределение и размер чанков|Количество чанков на шарде для конкретной коллекции.|Встроенная команда MongoDB db.collection.getShardDistribution()|
|mongodb_shard_jumbo_chunks_count|Количество "jumbo chunks" (чанков, которые невозможно разделить)|Если значение метрики больше 0 и растет - текущий ключ шардирования перестал справляться с объемом данных. Это прямая причина "горячих" шардов.|Prometheus + MongoDB Exporter|

## Механизмы автоматического перераспределения данных

### Тонкая настройка балансировщика MongoDB
MongoDB Balancer по умолчанию работает только на основе объема данных. 
Задача — сделать его работу более чувствительной к нагрузке, а не только к объему данных.
Остановить стандартный балансировщик (balancerStop) и создать свой скрипт-контроллер.

#### Активация балансировщика на основе метрик:
Алгоритм:
- контроллер опрашивает Prometheus (или напрямую БД), собирая метрики нагрузки (см. выше) по шардам.
- - если разница в нагрузке (например, по IOPS) между самым загруженным и самым свободным шардом превышает пороговое значение 
- - в течение определенного времени (чтобы избежать реакции на кратковременные всплески)
- тогда: контроллер запускает балансировщик (balancerStart). 
- после выравнивания балансировщик снова останавливается.

#### Приоритизация переноса чанков:
Стандартный балансировщик переносит самые большие чанки. Нужно заставить его переносить "самые горячие" чанки.
Алгоритм:
- контроллер определяет, чанки с какой коллекции создают наибольшую нагрузку (по метрике mongodb_collection_shard_operations_total).
- для этой коллекции находит конкретный чанк, который находится на перегруженном шарде.
- - если он не jumbo 
- тогда: принудительно его разделяет и/или перемещает.

### Автоматическое масштабирование
Алгоритм:
- если нагрузка на N шардах (например, метрики по CPU+IOPS) 
- - больше определенного порога величины 
- - в течение определенного порога времени
- тогда: автосоздание нового шард‑репликасета и запус балансера для распределения чанков.

### Алерты
Некоторые операции не стоит автоматизировать, стоит поставить их на *полуавтомат* - сообщать о проблеме и разбирать вручную, заранее подготовленным скриптом. 

#### Изменение ключа шардирования
По метрике mongodb_collection_shard_operations_total определять коллекции, для котоых стоит использовать составной ключ (определенный порог запросов уходит на ограниченное число шардов).

#### Предупрежедние о jumbo chunks
По метрике mongodb_shard_jumbo_chunks_count определять коллекции, для котоых необходимо разобраться с jumbo chunk (определенный порог jumbo chunk к общему количеству).